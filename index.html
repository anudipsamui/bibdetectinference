<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BIB Detector</title>
  <style>
    body { margin:0; font-family:Arial,sans-serif; text-align:center; background:#111; color:white; }
    h1 { margin-top:10px; }
    video, canvas { width:90%; max-width:500px; border-radius:12px; margin-top:10px; background:black; }
    #controls { margin-top:15px; }
    button {
      background-color:#007bff; color:white; border:none; padding:10px 20px; margin:5px;
      font-size:16px; border-radius:8px; cursor:pointer; transition:0.3s;
    }
    button:hover { background-color:#0056b3; }
    #status { margin-top:10px; font-size:16px; color:#0f0; }
  </style>

  <!-- Latest Roboflow InferenceJS -->
  <script src="https://cdn.jsdelivr.net/npm/@roboflow/inference-browser@1.2.0/dist/roboflow-inference.min.js"></script>
</head>
<body>
  <h1>BIB Detector</h1>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div id="controls">
    <button id="startBtn">Start Detection</button>
    <button id="stopBtn">Stop Detection</button>
  </div>

  <p id="status">Camera initializing...</p>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('status');
    let stream, detecting=false, animationFrameId;

    // ✅ Camera setup
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        statusEl.textContent = "Camera ready ✅";
      } catch(err) {
        console.error("Camera failed:", err);
        statusEl.textContent = "Camera failed ❌: " + err.message;
      }
    }

    startCamera();

    // ✅ Detection
    document.getElementById('startBtn').addEventListener('click', async () => {
      if(detecting) return;
      detecting = true;
      video.style.display="none";
      canvas.style.display="block";
      statusEl.textContent = "Loading model...";

      // 🔑 Initialize Roboflow engine
      const inferEngine = new Roboflow.InferenceEngine();
      let workerId;
      try {
        workerId = await inferEngine.startWorker(
          "bib-number-labeling", // model name
          14,                    // model version
          "rf_3HHrpOkdE4arP6EJhtDqcxZMpyf1" // Replace with your publishable key
        );
        statusEl.textContent = "Model loaded ✅ Detecting...";
      } catch(err) {
        console.error("Worker load failed:", err);
        statusEl.textContent = "Model load failed ❌";
        return;
      }

      async function detectFrame() {
        if(!detecting) return;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);

        try {
          const cvimg = new Roboflow.CVImage(video);
          const predictions = await inferEngine.infer(workerId, cvimg);

          // Draw bounding boxes
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          ctx.lineWidth = 3;
          ctx.strokeStyle = "lime";
          ctx.font = "18px Arial";
          ctx.fillStyle = "lime";
          predictions.forEach(pred => {
            const [x,y,w,h] = [
              pred.bbox.x - pred.bbox.width/2,
              pred.bbox.y - pred.bbox.height/2,
              pred.bbox.width,
              pred.bbox.height
            ];
            ctx.strokeRect(x,y,w,h);
            ctx.fillText(pred.class || "BIB", x, y-5);
          });

          statusEl.textContent = `Detected ${predictions.length} objects`;
        } catch(err) {
          console.error("Detection error:", err);
          statusEl.textContent = "Detection error ❌";
        }

        animationFrameId = requestAnimationFrame(detectFrame);
      }

      detectFrame();
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      detecting = false;
      cancelAnimationFrame(animationFrameId);
      canvas.style.display="none";
      video.style.display="block";
      statusEl.textContent = "Detection stopped.";
    });
  </script>

</body>
</html>
